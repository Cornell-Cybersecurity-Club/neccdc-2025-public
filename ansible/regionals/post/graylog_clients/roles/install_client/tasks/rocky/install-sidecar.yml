# https://github.com/rolehippie/graylog-sidecar/blob/master/tasks/main.yml
---
# https://go2docs.graylog.org/current/getting_in_log_data/install_sidecar_on_linux.htm
- name: Install repo
  ansible.builtin.dnf:
    name: 'https://packages.graylog2.org/repo/packages/graylog-sidecar-repository-1-5.noarch.rpm'
    state: present
    disable_gpg_check: true

- name: Install required package
  ansible.builtin.dnf:
    name: graylog-sidecar
    state: present

- name: Template the sidecar configuration
  ansible.builtin.template:
    src: templates/linux_sidecar.yml.j2
    dest: /etc/graylog/sidecar/sidecar.yml
    owner: root
    group: root
    mode: '0644'
  notify:
    - Restart linux-graylog-sidecar

- name: Write service file
  ansible.builtin.template:
    src: service.j2
    dest: /etc/systemd/system/graylog-sidecar.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - Restart linux-graylog-sidecar

- name: Start graylog-sidecar service
  ansible.builtin.service:
    name: graylog-sidecar
    state: started
    enabled: true
