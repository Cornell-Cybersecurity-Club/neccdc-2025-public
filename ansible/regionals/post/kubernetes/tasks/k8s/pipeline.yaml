---

- name: Copy Pipeline Files
  ansible.builtin.template:
    src: "templates/pipeline/{{ item }}"
    dest: "/home/ubuntu/pipeline/{{ item }}"
    owner: ubuntu
    group: ubuntu
    mode: '0644'
  loop:
    - etcher/ingress.yaml
    - grapher/ingress.yaml
    - recorder/ingress.yaml
  vars:
    team_id: "{{ hostvars[inventory_hostname]['team'] }}"
  tags:
    - services
    - pipeline

- name: Pipeline InfluxDB write credentials
  become: true
  become_user: ubuntu
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: influxdb-credentials
        namespace: pipeline
      data:
        INFLUX_BUCKET: "{{ 'PlaceboPharmaData' | b64encode }}"
        INFLUX_ORG: "{{ 'PlaceboPharma' | b64encode }}"
        INFLUXDB_TOKEN: "{{ lookup('file', '../../pre/database/output/pipeline-token') | b64encode }}"
        INFLUX_URL: "{{ 'https://10.0.{0}.196:8086'.format(hostvars[inventory_hostname]['team']) | b64encode }}"
  tags:
    - services
    - pipeline

- name: Pipeline Grapher InfluxDB read credentials
  become: true
  become_user: ubuntu
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: influxdb-grapher
        namespace: pipeline
      data:
        INFLUX_BUCKET: "{{ 'PlaceboPharmaData' | b64encode }}"
        INFLUX_ORG: "{{ 'PlaceboPharma' | b64encode }}"
        INFLUXDB_TOKEN: "{{ lookup('file', '../../pre/database/output/data-science-token') | b64encode }}"
        INFLUX_URL: "{{ 'https://10.0.{0}.196:8086'.format(hostvars[inventory_hostname]['team']) | b64encode }}"
  tags:
    - services
    - pipeline

- name: Deploy pipeline resources
  become: true
  become_user: ubuntu
  kubernetes.core.k8s:
    state: present
    src: "/home/ubuntu/pipeline/{{ item }}"
  loop:
    - etcher/configmap.yaml
    - etcher/deployment.yaml
    - etcher/ingress.yaml
    - etcher/service-monitor.yaml
    - etcher/service.yaml
    - grapher/configmap.yaml
    - grapher/deployment.yaml
    - grapher/ingress.yaml
    - grapher/service.yaml
    - recorder/configmap.yaml
    - recorder/deployment.yaml
    - recorder/ingress.yaml
    - recorder/rbac.yaml
    - recorder/service-monitor.yaml
    - recorder/service.yaml
  tags:
    - services
    - pipeline
