---
- name: Domain Join for Windows Servers and Workstations
  hosts: "{{ ansible_limit | default('windows_workstations') }}"
  gather_facts: true
  gather_subset: "!all,system"

  tasks:
    - name: Include AWS SAC Role
      ansible.builtin.include_role:
        name: aws.sac

    - name: Include Base Windows Role
      ansible.builtin.include_role:
        name: base.win
      vars:
        set_hostname: "{{ hostname }}"
        dns_servers: "{{ team_address.firewall_corp }}"
        ntp_resync: true

    - name: Join Object to Active Directory Domain
      microsoft.ad.membership:
       hostname: "{{ hostname }}"
       dns_domain_name: "{{ ad.domain }}"
       domain_admin_user: "{{ ansible_user }}@{{ ad.domain }}"
       domain_admin_password: "{{ ansible_password }}"
       reboot: true
       reboot_timeout: 600
       state: domain
